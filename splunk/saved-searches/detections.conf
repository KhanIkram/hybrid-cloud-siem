# savedsearches.conf
# Detection queries for network security monitoring
# 
# Copy to $SPLUNK_HOME/etc/apps/search/local/savedsearches.conf
# Or import via Splunk Web > Settings > Searches, reports, and alerts
#
# Note: Adjust index names and IP ranges to match your environment
# Examples use RFC 5737 documentation addresses (192.0.2.x, 198.51.100.x)

#######################################
# BASELINE QUERIES
#######################################

[Detection 01 - Device Inventory]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* OR src_ip=10.* OR src_ip=172.16.* \
| stats dc(dest_ip) as unique_destinations, sum(bytes) as bytes_total, count as flows by src_ip \
| eval MB = round(bytes_total/1024/1024, 2) \
| sort -flows \
| table src_ip, flows, unique_destinations, MB
description = Baseline - Identify all active internal hosts and their communication patterns
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

#######################################
# COMMAND & CONTROL DETECTIONS
#######################################

[Detection 02 - C2 Beaconing via Jitter Analysis]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.* OR dest_ip=172.16.*) \
| sort 0 src_ip, dest_ip, dest_port, _time \
| streamstats current=f window=1 last(_time) as prev_time by src_ip, dest_ip, dest_port \
| eval interval = _time - prev_time \
| where interval > 0 AND interval < 7200 \
| stats count as beacon_count, avg(interval) as avg_interval, stdev(interval) as stdev_interval by src_ip, dest_ip, dest_port \
| where beacon_count >= 10 \
| eval jitter_pct = round((stdev_interval / avg_interval) * 100, 1) \
| where jitter_pct < 25 \
| table src_ip, dest_ip, dest_port, beacon_count, avg_interval, jitter_pct \
| sort jitter_pct
description = T1071, T1573 - Detect automated C2 beaconing via low jitter analysis. Jitter = stdev/avg interval. Low jitter (<25%) indicates timer-based automated behavior.
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 07 - Long Duration Flows]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.*) \
| where duration > 3600 \
| stats count as flows, sum(bytes) as bytes_total, avg(duration) as avg_duration by src_ip, dest_ip, dest_port \
| where flows > 3 \
| eval hours = round(avg_duration/3600, 2) \
| eval MB = round(bytes_total/1024/1024, 2) \
| table src_ip, dest_ip, dest_port, flows, hours, MB \
| sort -hours
description = T1573 - Detect persistent connections that may indicate C2 channels or tunnels
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 08 - Non-Standard Port Usage]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.*) \
| where NOT dest_port IN (80, 443, 53, 123, 22, 25, 587, 993, 995, 8080, 8443) \
| stats count as flows, sum(bytes) as bytes_total, dc(src_ip) as unique_sources by dest_ip, dest_port \
| where flows > 50 \
| eval MB = round(bytes_total/1024/1024, 2) \
| table dest_ip, dest_port, flows, MB, unique_sources \
| sort -flows
description = T1571 - Detect traffic on unusual ports that may indicate tunneling or protocol evasion
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 11 - Unusual Protocol Usage]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* \
| where NOT protocol IN (6, 17, 1) \
| stats count as flows, sum(bytes) as bytes_total by src_ip, dest_ip, protocol \
| eval protocol_name = case(protocol=47, "GRE", protocol=50, "ESP", protocol=51, "AH", protocol=41, "IPv6-tunnel", 1=1, tostring(protocol)) \
| table src_ip, dest_ip, protocol, protocol_name, flows, bytes_total \
| sort -flows
description = T1095 - Detect traffic using uncommon protocols (GRE, ESP) that may indicate tunneling
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 14 - Known Suspicious Ports]
search = index=netflow earliest=-24h \
| search dest_port IN (4444, 5555, 6666, 1337, 31337, 8545, 3128, 9001, 9030, 9050, 9051) \
| stats count as flows, sum(bytes) as bytes_total by src_ip, dest_ip, dest_port \
| eval MB = round(bytes_total/1024/1024, 2) \
| table src_ip, dest_ip, dest_port, flows, MB \
| sort -flows
description = T1571 - Detect traffic to ports commonly associated with malware, exploits, or anonymization (Tor)
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 15 - ICMP Tunnel Detection]
search = index=netflow earliest=-24h \
| search protocol=1 \
| stats count as flows, sum(bytes) as bytes_total by src_ip, dest_ip \
| where bytes_total > 10000 \
| eval KB = round(bytes_total/1024, 2) \
| table src_ip, dest_ip, flows, KB \
| sort -KB
description = T1095 - Detect ICMP traffic with unusually high data volume that may indicate tunneling
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 10 - DNS to Non-Standard Resolver]
search = index=netflow earliest=-24h \
| search dest_port=53 OR src_port=53 \
| where NOT (dest_ip="8.8.8.8" OR dest_ip="8.8.4.4" OR dest_ip="1.1.1.1" OR dest_ip="1.0.0.1") \
| where NOT dest_ip LIKE "192.168.%" AND NOT dest_ip LIKE "10.%" \
| stats count as flows, sum(bytes) as bytes_total by src_ip, dest_ip \
| where flows > 10 \
| table src_ip, dest_ip, flows, bytes_total \
| sort -flows
description = T1071.004 - Detect DNS traffic to non-standard resolvers that may indicate DNS tunneling or exfiltration
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

#######################################
# RECONNAISSANCE DETECTIONS
#######################################

[Detection 03 - Port Scanning]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* OR src_ip=10.* \
| bin _time span=1h \
| stats dc(dest_port) as unique_ports, dc(dest_ip) as unique_targets, count as flows by _time, src_ip \
| where unique_ports > 50 OR unique_targets > 200 \
| eval hour = strftime(_time, "%Y-%m-%d %H:%M") \
| table hour, src_ip, unique_ports, unique_targets, flows \
| sort -unique_ports
description = T1046 - Detect port scanning behavior. Thresholds tuned to reduce false positives from normal browsing.
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

#######################################
# LATERAL MOVEMENT DETECTIONS
#######################################

[Detection 06 - Internal Admin Port Access]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* dest_ip=192.168.* \
| search dest_port IN (22, 23, 135, 139, 445, 3389, 5985, 5986) \
| stats dc(dest_ip) as unique_targets, count as flows, sum(bytes) as bytes_total by src_ip, dest_port \
| where unique_targets > 1 \
| eval MB = round(bytes_total/1024/1024, 2) \
| table src_ip, dest_port, unique_targets, flows, MB \
| sort -unique_targets
description = T1021 - Detect internal hosts accessing multiple targets on administrative ports (SSH, RDP, SMB, WinRM)
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

#######################################
# EXFILTRATION DETECTIONS
#######################################

[Detection 04 - Volume Anomaly via Z-Score]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.*) \
| bin _time span=1h \
| stats sum(bytes) as hourly_bytes by _time, src_ip \
| eventstats avg(hourly_bytes) as avg_bytes, stdev(hourly_bytes) as stdev_bytes by src_ip \
| where stdev_bytes > 0 \
| eval zscore = round((hourly_bytes - avg_bytes) / stdev_bytes, 2) \
| where zscore > 2 \
| eval MB = round(hourly_bytes/1024/1024, 2) \
| eval hour = strftime(_time, "%Y-%m-%d %H:%M") \
| table hour, src_ip, MB, zscore \
| sort -zscore
description = T1041 - Detect unusual outbound data volumes using z-score statistical analysis. Flags hours >2 standard deviations from mean.
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 09 - Large Transfers to Single Destination]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.*) \
| stats sum(bytes) as bytes_total, count as flows by src_ip, dest_ip \
| where bytes_total > 5000000 \
| eval MB = round(bytes_total/1024/1024, 2) \
| sort -MB \
| head 20 \
| table src_ip, dest_ip, MB, flows
description = T1041 - Detect large data transfers to single external destinations that may indicate exfiltration
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 12 - After Hours Activity]
search = index=netflow earliest=-7d \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.*) \
| eval hour_utc = tonumber(strftime(_time, "%H")) \
| eval minute_utc = tonumber(strftime(_time, "%M")) \
| eval time_decimal = hour_utc + (minute_utc / 60) \
| where time_decimal >= 8.0 AND time_decimal < 13.5 \
| stats count as flows, sum(bytes) as bytes_total, dc(dest_ip) as unique_dests by src_ip \
| eval MB = round(bytes_total/1024/1024, 2) \
| table src_ip, flows, unique_dests, MB \
| sort -flows
description = T1029 - Detect network activity during unusual hours (adjust UTC offset for your timezone). Default: 3-8:30 AM local.
dispatch.earliest_time = -7d
dispatch.latest_time = now
is_scheduled = 0

#######################################
# INITIAL ACCESS / NEW ACTIVITY
#######################################

[Detection 05 - New External Destinations]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* NOT (dest_ip=192.168.* OR dest_ip=10.*) \
| stats earliest(_time) as first_seen, count as flows, sum(bytes) as bytes_total by dest_ip \
| where first_seen > relative_time(now(), "-4h") \
| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M:%S") \
| eval MB = round(bytes_total/1024/1024, 2) \
| sort -flows \
| table dest_ip, first_seen, flows, MB \
| head 20
description = T1071 - Detect connections to previously unseen external IPs. Useful for identifying new C2 infrastructure.
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

[Detection 13 - New Internal Device]
search = index=netflow earliest=-24h \
| search src_ip=192.168.* OR src_ip=10.* \
| stats earliest(_time) as first_seen, count as flows by src_ip \
| where first_seen > relative_time(now(), "-4h") \
| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M:%S") \
| table src_ip, first_seen, flows \
| sort -flows
description = T1200 - Detect new devices appearing on the internal network
dispatch.earliest_time = -24h
dispatch.latest_time = now
is_scheduled = 0

#######################################
# OPERATIONAL ALERTS
#######################################

[Alert - Pipeline Health Check]
search = | tstats latest(_time) as last_event WHERE index=syslog OR index=netflow by index \
| eval minutes_ago = round((now() - last_event) / 60, 1) \
| where minutes_ago >= 30 \
| eval status = case(minutes_ago < 60, "Warning", 1=1, "Critical") \
| eval last_event_time = strftime(last_event, "%Y-%m-%d %H:%M:%S") \
| table index, last_event_time, minutes_ago, status
description = Alert when data pipelines go silent for 30+ minutes. Critical for detecting ingestion failures.
dispatch.earliest_time = -60m
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert.track = 1
alert.severity = 4
alert_condition = search count > 0

[Alert - License Usage Warning]
search = | rest /services/licenser/pools \
| stats sum(used_bytes) as used, sum(effective_quota) as quota \
| eval pct_used = round((used/quota)*100, 1) \
| where pct_used > 80 \
| eval used_MB = round(used/1024/1024, 0) \
| eval quota_MB = round(quota/1024/1024, 0) \
| table used_MB, quota_MB, pct_used
description = Alert when daily license usage exceeds 80%
dispatch.earliest_time = -24h
dispatch.latest_time = now
cron_schedule = 0 */4 * * *
is_scheduled = 1
alert.track = 1
alert.severity = 3
alert_condition = search count > 0
