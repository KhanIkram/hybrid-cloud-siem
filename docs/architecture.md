# Architecture Documentation

Detailed architecture diagrams and data flow documentation.

---

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    HOME NETWORK                                      │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         NETWORK SECURITY APPLIANCE                              │ │
│  │                                                                                 │ │
│  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────────┐   │ │
│  │   │  Firewall   │   │    DHCP     │   │     DNS     │   │    NetFlow      │   │ │
│  │   │   Engine    │   │   Server    │   │   Resolver  │   │    Exporter     │   │ │
│  │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └────────┬────────┘   │ │
│  │          │                 │                 │                    │           │ │
│  │          └─────────────────┴─────────────────┘                    │           │ │
│  │                            │                                      │           │ │
│  │                      Syslog Export                          IPFIX v10         │ │
│  │                       (UDP:5514)                            (UDP:2055)        │ │
│  └────────────────────────────┼──────────────────────────────────────┼───────────┘ │
│                               │                                      │             │
└───────────────────────────────┼──────────────────────────────────────┼─────────────┘
                                │                                      │
                                │           PUBLIC INTERNET            │
                                │                                      │
┌───────────────────────────────┼──────────────────────────────────────┼─────────────┐
│                            CLOUD ENVIRONMENT                                        │
│                                                                                     │
│  ┌────────────────────────────┼──────────────────────────────────────┼───────────┐ │
│  │                         SECURITY GROUP (Firewall)                              │ │
│  │                    Allow: UDP 5514, UDP 2055 from WAN IP                       │ │
│  └────────────────────────────┼──────────────────────────────────────┼───────────┘ │
│                               │                                      │             │
│  ┌────────────────────────────▼──────────────────────────────────────▼───────────┐ │
│  │                           SPLUNK ENTERPRISE                                    │ │
│  │                                                                                │ │
│  │   ┌─────────────────────────────┐     ┌─────────────────────────────┐         │ │
│  │   │        UDP:5514             │     │         nfcapd              │         │ │
│  │   │    (Syslog Receiver)        │     │    (NetFlow Collector)      │         │ │
│  │   │                             │     │        UDP:2055             │         │ │
│  │   └──────────────┬──────────────┘     └──────────────┬──────────────┘         │ │
│  │                  │                                   │                         │ │
│  │                  ▼                                   ▼                         │ │
│  │   ┌─────────────────────────────┐     ┌─────────────────────────────┐         │ │
│  │   │        TA-syslog            │     │      process_flows.sh       │         │ │
│  │   │   (Field Extraction)        │     │   (Binary → NDJSON)         │         │ │
│  │   └──────────────┬──────────────┘     └──────────────┬──────────────┘         │ │
│  │                  │                                   │                         │ │
│  │                  ▼                                   ▼                         │ │
│  │   ┌─────────────────────────────┐     ┌─────────────────────────────┐         │ │
│  │   │      syslog index           │     │      TA-netflow             │         │ │
│  │   │  • network:firewall         │     │   (JSON Parsing + CIM)      │         │ │
│  │   │  • network:dhcp             │     └──────────────┬──────────────┘         │ │
│  │   │  • network:dns              │                    │                         │ │
│  │   └──────────────┬──────────────┘                    ▼                         │ │
│  │                  │                    ┌─────────────────────────────┐         │ │
│  │                  │                    │      netflow index          │         │ │
│  │                  │                    │   • network:netflow         │         │ │
│  │                  │                    └──────────────┬──────────────┘         │ │
│  │                  │                                   │                         │ │
│  │                  └───────────────┬───────────────────┘                         │ │
│  │                                  │                                             │ │
│  │                                  ▼                                             │ │
│  │                   ┌─────────────────────────────┐                              │ │
│  │                   │    15 Detection Queries     │                              │ │
│  │                   │    (Saved Searches)         │                              │ │
│  │                   └──────────────┬──────────────┘                              │ │
│  │                                  │                                             │ │
│  │                                  │ REST API (:8089)                            │ │
│  └──────────────────────────────────┼─────────────────────────────────────────────┘ │
│                                     │                                               │
│  ┌──────────────────────────────────▼─────────────────────────────────────────────┐ │
│  │                          MCP THREAT HUNTER                                      │ │
│  │                                                                                 │ │
│  │   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐              │ │
│  │   │  Splunk Client  │   │ VirusTotal API  │   │ AbuseIPDB API   │              │ │
│  │   │   (Async HTTP)  │   │   (Enrichment)  │   │  (Enrichment)   │              │ │
│  │   └────────┬────────┘   └────────┬────────┘   └────────┬────────┘              │ │
│  │            │                     │                     │                        │ │
│  │            └─────────────────────┴─────────────────────┘                        │ │
│  │                                  │                                              │ │
│  │                    Combined Verdict Synthesis                                   │ │
│  │                                  │                                              │ │
│  └──────────────────────────────────┼──────────────────────────────────────────────┘ │
│                                     │                                               │
└─────────────────────────────────────┼───────────────────────────────────────────────┘
                                      │
                                      ▼
                       ┌─────────────────────────────┐
                       │        CLAUDE CODE          │
                       │   Natural Language Threat   │
                       │         Hunting             │
                       └─────────────────────────────┘
```

---

## Data Flow Details

### Syslog Pipeline

```
Network Appliance
       │
       │ UDP:5514
       ▼
┌─────────────────────────┐
│   Splunk UDP Input      │
│   [udp://5514]          │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   TA-syslog             │
│   • transforms.conf     │──▶ Sourcetype routing
│   • props.conf          │──▶ Field extraction
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   Indexes               │
│   • syslog              │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   Sourcetypes           │
│   • network:firewall    │
│   • network:dhcp        │
│   • network:dns         │
└─────────────────────────┘
```

### NetFlow Pipeline

```
Network Appliance
       │
       │ IPFIX v10 (UDP:2055)
       ▼
┌─────────────────────────┐
│   nfcapd (Collector)    │
│   Binary flow capture   │
└───────────┬─────────────┘
            │
            │ Cron: Every 5 minutes
            ▼
┌─────────────────────────┐
│   process_flows.sh      │
│   • nfdump -o json      │
│   • jq (to NDJSON)      │
│   • Optional: sampling  │
└───────────┬─────────────┘
            │
            │ /opt/netflow/processed/*.json
            ▼
┌─────────────────────────┐
│   Splunk File Monitor   │
│   [monitor://...]       │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   TA-netflow            │
│   • KV_MODE = json      │
│   • CIM field aliases   │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   Index: netflow        │
│   Sourcetype:           │
│   network:netflow       │
└─────────────────────────┘
```

---

## MCP Server Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         MCP SERVER                               │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                     TOOL LAYER                              │ │
│  │                                                             │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │ │
│  │  │search_splunk │  │  enrich_ip   │  │ hunt_beacons │     │ │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤     │ │
│  │  │hunt_ioc      │  │enrich_domain │  │hunt_volume   │     │ │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤     │ │
│  │  │get_summary   │  │ enrich_hash  │  │hunt_new_dest │     │ │
│  │  ├──────────────┤  └──────────────┘  └──────────────┘     │ │
│  │  │check_health  │                                          │ │
│  │  └──────────────┘                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌───────────────────────────▼────────────────────────────────┐ │
│  │                    CLIENT LAYER                             │ │
│  │                                                             │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │                  SplunkClient                         │  │ │
│  │  │  • Async HTTP (httpx)                                 │  │ │
│  │  │  • Job-based search API                               │  │ │
│  │  │  • Polling for completion                             │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                                                             │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │              VirusTotalClient                         │  │ │
│  │  │  • IP, Domain, Hash lookups                           │  │ │
│  │  │  • Verdict classification                             │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                                                             │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │              AbuseIPDBClient                          │  │ │
│  │  │  • IP abuse checking                                  │  │ │
│  │  │  • Abuse confidence scoring                           │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌───────────────────────────▼────────────────────────────────┐ │
│  │                 ENRICHMENT SYNTHESIS                        │ │
│  │                                                             │ │
│  │    asyncio.gather(vt_lookup, abuseipdb_lookup)             │ │
│  │                        │                                    │ │
│  │                        ▼                                    │ │
│  │    ┌─────────────────────────────────────────┐             │ │
│  │    │  Combined Verdict Logic                  │             │ │
│  │    │  • If ANY source = MALICIOUS → MALICIOUS │             │ │
│  │    │  • If ANY source = SUSPICIOUS → SUSPICIOUS│            │ │
│  │    │  • Otherwise → CLEAN                     │             │ │
│  │    └─────────────────────────────────────────┘             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌───────────────────────────▼────────────────────────────────┐ │
│  │                    MCP PROTOCOL                             │ │
│  │                                                             │ │
│  │    stdio_server() ←→ JSON-RPC over stdin/stdout            │ │
│  │                                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │    Claude Code      │
                    │    (CLI Client)     │
                    └─────────────────────┘
```

---

## Security Boundaries

```
┌─────────────────────────────────────────────────────────────────┐
│                        TRUST ZONES                               │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ZONE 1: Home Network (Trusted)                            │  │
│  │  • Internal hosts (192.168.x.x)                            │  │
│  │  • Network appliance                                       │  │
│  │  • Management access                                       │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                    NAT / Firewall                                │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ZONE 2: Public Internet (Untrusted)                       │  │
│  │  • All external destinations                               │  │
│  │  • Threat actor infrastructure                             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│               Cloud Security Group                               │
│         (Allow specific ports from WAN IP only)                  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ZONE 3: Cloud SIEM (Semi-Trusted)                         │  │
│  │  • Splunk Enterprise                                       │  │
│  │  • MCP Server                                              │  │
│  │  • Restricted API access                                   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                    HTTPS (443)                                   │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ZONE 4: Threat Intelligence APIs (External)               │  │
│  │  • VirusTotal                                              │  │
│  │  • AbuseIPDB                                               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## Component Interaction Sequence

### Threat Hunting Workflow

```
User                Claude Code           MCP Server              Splunk          VirusTotal    AbuseIPDB
 │                      │                     │                     │                 │             │
 │  "Hunt for beacons"  │                     │                     │                 │             │
 │─────────────────────▶│                     │                     │                 │             │
 │                      │   call hunt_beacons │                     │                 │             │
 │                      │────────────────────▶│                     │                 │             │
 │                      │                     │   POST /search/jobs │                 │             │
 │                      │                     │────────────────────▶│                 │             │
 │                      │                     │      job_sid        │                 │             │
 │                      │                     │◀────────────────────│                 │             │
 │                      │                     │   poll status       │                 │             │
 │                      │                     │────────────────────▶│                 │             │
 │                      │                     │   GET results       │                 │             │
 │                      │                     │────────────────────▶│                 │             │
 │                      │                     │   [low jitter IPs]  │                 │             │
 │                      │                     │◀────────────────────│                 │             │
 │                      │   results + analysis│                     │                 │             │
 │                      │◀────────────────────│                     │                 │             │
 │                      │                     │                     │                 │             │
 │                      │  call enrich_ip     │                     │                 │             │
 │                      │────────────────────▶│                     │                 │             │
 │                      │                     │                  GET /ip_addresses/x.x.x.x         │
 │                      │                     │─────────────────────────────────────▶│             │
 │                      │                     │                  GET /check?ip=x.x.x.x            │
 │                      │                     │───────────────────────────────────────────────────▶│
 │                      │                     │                     │    VT verdict   │             │
 │                      │                     │◀─────────────────────────────────────│             │
 │                      │                     │                     │        AbuseIPDB verdict     │
 │                      │                     │◀───────────────────────────────────────────────────│
 │                      │                     │                     │                 │             │
 │                      │                     │  combine verdicts   │                 │             │
 │                      │                     │────────┐            │                 │             │
 │                      │                     │        │            │                 │             │
 │                      │                     │◀───────┘            │                 │             │
 │                      │   enriched results  │                     │                 │             │
 │                      │◀────────────────────│                     │                 │             │
 │   summary + findings │                     │                     │                 │             │
 │◀─────────────────────│                     │                     │                 │             │
 │                      │                     │                     │                 │             │
```

---

## Deployment Patterns

### Single Host (Development)

```
┌─────────────────────────────────────────┐
│           Single VM/Server              │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         Splunk Enterprise        │   │
│  │  • Indexer                       │   │
│  │  • Search Head                   │   │
│  │  • UDP Inputs                    │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         nfcapd + scripts         │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         MCP Server               │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### Distributed (Production-like)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Flow Collector │    │  Splunk Server  │    │   MCP Server    │
│                 │    │                 │    │                 │
│  • nfcapd       │───▶│  • Indexer      │◀───│  • Python       │
│  • processing   │    │  • Search Head  │    │  • API clients  │
│                 │    │  • Web UI       │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```
